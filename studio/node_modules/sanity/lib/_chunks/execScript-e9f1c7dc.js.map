{"version":3,"file":"execScript-e9f1c7dc.js","sources":["../../src/_internal/cli/actions/exec/execScript.ts"],"sourcesContent":["import {spawn} from 'child_process'\nimport fs from 'fs/promises'\nimport path from 'path'\nimport type {CliCommandAction, CliCommandArguments} from '@sanity/cli'\nimport yargs from 'yargs/yargs'\nimport {hideBin} from 'yargs/helpers'\nimport readPkgUp from 'read-pkg-up'\n\ninterface ExecFlags {\n  'with-user-token'?: boolean\n  'mock-browser-env'?: boolean\n}\n\nfunction parseCliFlags(args: CliCommandArguments<ExecFlags>) {\n  return yargs(hideBin(args.argv || process.argv)).command(\n    'exec [script]',\n    'executes given script',\n    (cmd) =>\n      cmd\n        .positional('script', {type: 'string', demandOption: true})\n        .option('with-user-token', {type: 'boolean', default: false})\n        .option('mock-browser-env', {type: 'boolean', default: false})\n  ).argv\n}\n\nconst execScript: CliCommandAction<ExecFlags> = async function execScript(args, context) {\n  // Reparsing CLI flags for better control of binary flags\n  const {withUserToken, mockBrowserEnv, script} = await parseCliFlags(args)\n  const {workDir} = context\n\n  const scriptPath = path.resolve(script || '')\n  if (!script) {\n    throw new Error('SCRIPT must be provided. `sanity exec <script>`')\n  }\n\n  if (!(await fs.stat(scriptPath).catch(() => false))) {\n    throw new Error(`${scriptPath} does not exist`)\n  }\n\n  const sanityPkgPath = (await readPkgUp({cwd: __dirname}))?.path\n  if (!sanityPkgPath) {\n    throw new Error('Unable to resolve `sanity` module root')\n  }\n\n  const sanityDir = path.dirname(sanityPkgPath)\n  const threadsDir = path.join(sanityDir, 'lib', '_internal', 'cli', 'threads')\n  const esbuildPath = path.join(threadsDir, 'esbuild.js')\n  const browserEnvPath = path.join(threadsDir, 'registerBrowserEnv.js')\n  const configClientPath = path.join(threadsDir, 'configClient.js')\n\n  if (!(await fs.stat(esbuildPath).catch(() => false))) {\n    throw new Error('`sanity` module build error: missing threads')\n  }\n\n  const baseArgs = mockBrowserEnv ? ['-r', browserEnvPath] : ['-r', esbuildPath]\n  const tokenArgs = withUserToken ? ['-r', configClientPath] : []\n\n  const nodeArgs = [...baseArgs, ...tokenArgs, scriptPath, ...args.extraArguments]\n\n  const proc = spawn(process.argv[0], nodeArgs, {\n    stdio: 'inherit',\n    env: {\n      // eslint-disable-next-line no-process-env\n      ...process.env,\n      SANITY_BASE_PATH: workDir,\n    },\n  })\n  proc.on('close', process.exit)\n}\n\nexport default execScript\n"],"names":["parseCliFlags","args","yargs","hideBin","argv","process","command","cmd","positional","type","demandOption","option","default","execScript","context","_a","withUserToken","mockBrowserEnv","script","workDir","scriptPath","path","resolve","Error","fs","stat","catch","sanityPkgPath","readPkgUp","cwd","__dirname","sanityDir","dirname","threadsDir","join","esbuildPath","browserEnvPath","configClientPath","baseArgs","tokenArgs","nodeArgs","extraArguments","proc","spawn","stdio","env","SANITY_BASE_PATH","on","exit"],"mappings":"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"}