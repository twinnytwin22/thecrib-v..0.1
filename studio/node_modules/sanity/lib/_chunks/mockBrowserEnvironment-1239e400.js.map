{"version":3,"file":"mockBrowserEnvironment-1239e400.js","sources":["../../src/_internal/cli/util/mockBrowserEnvironment.ts"],"sourcesContent":["import {addHook} from 'pirates'\nimport jsdomGlobal from 'jsdom-global'\nimport resolveFrom from 'resolve-from'\nimport {register as registerESBuild} from 'esbuild-register/dist/node'\n\nconst jsdomDefaultHtml = `<!doctype html>\n<html>\n  <head><meta charset=\"utf-8\"></head>\n  <body></body>\n</html>`\n\nexport function mockBrowserEnvironment(basePath: string): () => void {\n  // Guard against double-registering\n  if (global && global.window && '__mockedBySanity' in global.window) {\n    return () => {\n      /* intentional noop */\n    }\n  }\n\n  const domCleanup = jsdomGlobal(jsdomDefaultHtml, {url: 'http://localhost:3333/'})\n  const windowCleanup = () => global.window.close()\n  const globalCleanup = provideFakeGlobals(basePath)\n  const cleanupFileLoader = addHook(\n    (code, filename) => `module.exports = ${JSON.stringify(filename)}`,\n    {\n      ignoreNodeModules: false,\n      exts: getFileExtensions(),\n    }\n  )\n\n  const {unregister: unregisterESBuild} = registerESBuild({\n    target: 'node14',\n  })\n\n  return function cleanupBrowserEnvironment() {\n    unregisterESBuild()\n    cleanupFileLoader()\n    globalCleanup()\n    windowCleanup()\n    domCleanup()\n  }\n}\n\nconst getFakeGlobals = (basePath: string) => ({\n  __mockedBySanity: true,\n  requestAnimationFrame: setImmediate,\n  cancelAnimationFrame: clearImmediate,\n  requestIdleCallback: setImmediate,\n  cancelIdleCallback: clearImmediate,\n  InputEvent: global.window && global.window.InputEvent,\n  ace: tryGetAceGlobal(basePath),\n})\n\nfunction provideFakeGlobals(basePath: string): () => void {\n  const globalEnv = global as any as Record<string, unknown>\n  const globalWindow = global.window as Record<string, any>\n\n  const fakeGlobals = getFakeGlobals(basePath)\n  const stubbedGlobalKeys: string[] = []\n  const stubbedWindowKeys: string[] = []\n\n  for (const [rawKey, value] of Object.entries(fakeGlobals)) {\n    if (typeof value === 'undefined') {\n      continue\n    }\n\n    const key = rawKey as keyof typeof fakeGlobals\n\n    if (!(key in globalEnv)) {\n      globalEnv[key] = fakeGlobals[key]\n      stubbedGlobalKeys.push(key)\n    }\n\n    if (!(key in global.window)) {\n      globalWindow[key] = fakeGlobals[key]\n      stubbedWindowKeys.push(key)\n    }\n  }\n\n  return () => {\n    stubbedGlobalKeys.forEach((key) => {\n      delete globalEnv[key]\n    })\n\n    stubbedWindowKeys.forEach((key) => {\n      delete globalWindow[key]\n    })\n  }\n}\n\nfunction tryGetAceGlobal(basePath: string) {\n  // Work around an issue where using the @sanity/code-input plugin would crash\n  // due to `ace` not being defined on the global due to odd bundling stategy.\n  const acePath = resolveFrom.silent(basePath, 'ace-builds')\n  if (!acePath) {\n    return undefined\n  }\n\n  try {\n    // eslint-disable-next-line import/no-dynamic-require\n    return require(acePath)\n  } catch (err) {\n    return undefined\n  }\n}\n\nfunction getFileExtensions() {\n  return [\n    '.jpeg',\n    '.jpg',\n    '.png',\n    '.gif',\n    '.svg',\n    '.webp',\n    '.woff',\n    '.woff2',\n    '.ttf',\n    '.eot',\n    '.otf',\n    '.css',\n  ]\n}\n"],"names":["jsdomDefaultHtml","mockBrowserEnvironment","basePath","global","window","domCleanup","jsdomGlobal","url","windowCleanup","close","globalCleanup","provideFakeGlobals","cleanupFileLoader","addHook","code","filename","JSON","stringify","ignoreNodeModules","exts","getFileExtensions","unregister","unregisterESBuild","registerESBuild","target","cleanupBrowserEnvironment","getFakeGlobals","__mockedBySanity","requestAnimationFrame","setImmediate","cancelAnimationFrame","clearImmediate","requestIdleCallback","cancelIdleCallback","InputEvent","ace","tryGetAceGlobal","globalEnv","globalWindow","fakeGlobals","stubbedGlobalKeys","stubbedWindowKeys","rawKey","value","Object","entries","key","push","forEach","acePath","resolveFrom","default","silent","require","err"],"mappings":"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"}