{"version":3,"file":"servers-214c2a6f.js","sources":["../../src/_internal/cli/util/servers.ts"],"sourcesContent":["import type {CliConfig} from '@sanity/cli'\n\nexport function gracefulServerDeath(\n  command: 'start' | 'dev' | 'preview',\n  httpHost: string | undefined,\n  httpPort: number,\n  err: Error & {code?: string}\n): void {\n  if (err.code === 'EADDRINUSE') {\n    throw new Error(\n      `Port number is already in use, configure \\`server.port\\` in \\`sanity.cli.js\\` or pass \\`--port <somePort>\\` to \\`sanity ${command}\\``\n    )\n  }\n\n  if (err.code === 'EACCES') {\n    const help =\n      httpPort < 1024\n        ? 'port numbers below 1024 requires root privileges'\n        : `do you have access to listen to the given host (${httpHost || '127.0.0.1'})?`\n\n    throw new Error(`The studio server does not have access to listen to given port - ${help}`)\n  }\n\n  throw err\n}\n\n/**\n * Resolves the shared configuration for the dev/preview server using:\n *\n * - CLI flags\n * - Environment variables\n * - User build config\n * - Default configuration\n */\nexport function getSharedServerConfig({\n  flags,\n  workDir,\n  cliConfig,\n}: {\n  flags: {host?: string; port?: string}\n  workDir: string\n  cliConfig?: CliConfig\n}): {\n  cwd: string\n  httpPort: number\n  httpHost: string\n  basePath: string\n  vite: CliConfig['vite']\n} {\n  // Order of preference: CLI flags, environment variables, user build config, default config\n  const env = process.env // eslint-disable-line no-process-env\n\n  const httpHost =\n    flags.host || env.SANITY_STUDIO_SERVER_HOSTNAME || cliConfig?.server?.hostname || 'localhost'\n\n  const httpPort = toInt(\n    flags.port || env.SANITY_STUDIO_SERVER_PORT || cliConfig?.server?.port,\n    3333\n  )\n\n  const basePath = env.SANITY_STUDIO_BASEPATH || cliConfig?.project?.basePath || '/'\n\n  return {\n    cwd: workDir,\n    httpPort,\n    httpHost,\n    basePath,\n    vite: cliConfig?.vite,\n  }\n}\n\nfunction toInt(value: string | number | undefined, defaultValue: number): number {\n  if (typeof value === 'undefined') {\n    return defaultValue\n  }\n\n  const intVal = parseInt(`${value}`, 10)\n  return Number.isFinite(intVal) ? intVal : defaultValue\n}\n"],"names":["gracefulServerDeath","command","httpHost","httpPort","err","code","Error","help","getSharedServerConfig","flags","workDir","cliConfig","_a","_b","_c","env","process","host","SANITY_STUDIO_SERVER_HOSTNAME","server","hostname","toInt","port","SANITY_STUDIO_SERVER_PORT","basePath","SANITY_STUDIO_BASEPATH","project","cwd","vite","value","defaultValue","intVal","parseInt","Number","isFinite"],"mappings":";;AAEO,SAASA,mBACd,CAAAC,OAAA,EACAC,QACA,EAAAC,QAAA,EACAC,GACM,EAAA;EACF,IAAAA,GAAA,CAAIC,SAAS,YAAc,EAAA;IAC7B,MAAM,IAAIC,KAAA,4HACmHL,OAAA,OAC7H;EACF;EAEI,IAAAG,GAAA,CAAIC,SAAS,QAAU,EAAA;IACzB,MAAME,IACJ,GAAAJ,QAAA,GAAW,IACP,GAAA,kDAAA,6DACmDD,QAAY,IAAA,WAAA,OAAA;IAE/D,MAAA,IAAII,KAAM,4EAAoEC,IAAM,EAAA;EAC5F;EAEM,MAAAH,GAAA;AACR;AAUO,SAASI,qBAAsB,OAcpC;EAAA,IAdoC;IACpCC,KAAA;IACAC,OAAA;IACAC;EACF,CAUE;EAhDF,IAAAC,EAAA,EAAAC,EAAA,EAAAC,EAAA;EAkDE,MAAMC,MAAMC,OAAQ,CAAAD,GAAA;EAEd,MAAAb,QAAA,GACJO,MAAMQ,IAAQ,IAAAF,GAAA,CAAIG,mCAAiCN,EAAW,GAAAD,SAAA,IAAA,IAAA,GAAA,KAAA,CAAA,GAAAA,SAAA,CAAAQ,MAAA,KAAX,mBAAmBC,QAAY,CAAA,IAAA,WAAA;EAEpF,MAAMjB,QAAW,GAAAkB,KAAA,CACfZ,MAAMa,IAAQ,IAAAP,GAAA,CAAIQ,yBAA6B,KAAA,CAAAV,EAAA,GAAAF,SAAA,IAAA,IAAA,GAAA,KAAA,CAAA,GAAAA,SAAA,CAAWQ,WAAX,IAAmB,GAAA,KAAA,CAAA,GAAAN,EAAA,CAAAS,IAAA,CAAA,EAClE,IAAA,CACF;EAEA,MAAME,WAAWT,GAAI,CAAAU,sBAAA,KAAA,CAA0BX,EAAW,GAAAH,SAAA,IAAA,IAAA,GAAA,KAAA,CAAA,GAAAA,SAAA,CAAAe,OAAA,KAAX,mBAAoBF,QAAY,CAAA,IAAA,GAAA;EAExE,OAAA;IACLG,GAAK,EAAAjB,OAAA;IACLP,QAAA;IACAD,QAAA;IACAsB,QAAA;IACAI,MAAMjB,SAAW,IAAA,IAAA,GAAA,KAAA,CAAA,GAAAA,SAAA,CAAAiB;EAAA,CACnB;AACF;AAEA,SAASP,KAAA,CAAMQ,OAAoCC,YAA8B,EAAA;EAC3E,IAAA,OAAOD,UAAU,WAAa,EAAA;IACzB,OAAAC,YAAA;EACT;EAEA,MAAMC,MAAS,GAAAC,QAAA,WAAYH,KAAA,GAAS,EAAE,CAAA;EACtC,OAAOI,MAAO,CAAAC,QAAA,CAASH,MAAM,CAAA,GAAIA,MAAS,GAAAD,YAAA;AAC5C;;"}