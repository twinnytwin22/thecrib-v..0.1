{"version":3,"file":"tunnel.js","names":["url","require","tunnel","uriParts","defaultProxyHeaderWhiteList","defaultProxyHeaderExclusiveList","exports","shouldEnable","options","tunnelOption","Boolean","uri","parse","protocol","applyAgent","opts","proxy","Object","assign","proxyHeaderWhiteList","concat","map","header","toLowerCase","proxyHeaderExclusiveList","proxyHeaders","getAllowedProxyHeaders","headers","host","constructProxyHost","keys","reduce","isAllowed","indexOf","tunnelFn","getTunnelFn","tunnelOptions","constructTunnelOptions","agent","getUriParts","tunnelFnName","constructTunnelFnName","part","uriProtocol","proxyProtocol","join","port","proxyHost","hostname","whiteList","filter","set","proxyAuth","auth","ca","cert","key","passphrase","pfx","ciphers","rejectUnauthorized","secureOptions","secureProtocol"],"sources":["../../../src/request/node/tunnel.js"],"sourcesContent":["/**\n * Code borrowed from https://github.com/request/request\n * Modified to be less request-specific, more functional\n * Apache License 2.0\n */\nconst url = require('url')\nconst tunnel = require('tunnel-agent')\n\nconst uriParts = [\n  'protocol',\n  'slashes',\n  'auth',\n  'host',\n  'port',\n  'hostname',\n  'hash',\n  'search',\n  'query',\n  'pathname',\n  'path',\n  'href'\n]\n\nconst defaultProxyHeaderWhiteList = [\n  'accept',\n  'accept-charset',\n  'accept-encoding',\n  'accept-language',\n  'accept-ranges',\n  'cache-control',\n  'content-encoding',\n  'content-language',\n  'content-location',\n  'content-md5',\n  'content-range',\n  'content-type',\n  'connection',\n  'date',\n  'expect',\n  'max-forwards',\n  'pragma',\n  'referer',\n  'te',\n  'user-agent',\n  'via'\n]\n\nconst defaultProxyHeaderExclusiveList = ['proxy-authorization']\n\nexports.shouldEnable = (options, tunnelOption) => {\n  // Tunnel HTTPS by default. Allow the user to override this setting.\n\n  // If user has specified a specific tunnel override...\n  if (typeof options.tunnel !== 'undefined') {\n    return Boolean(options.tunnel)\n  }\n\n  // If the destination is HTTPS, tunnel.\n  const uri = url.parse(options.url)\n  if (uri.protocol === 'https:') {\n    return true\n  }\n\n  // Otherwise, do not use tunnel.\n  return false\n}\n\nexports.applyAgent = (opts = {}, proxy) => {\n  const options = Object.assign({}, opts)\n\n  // Setup proxy header exclusive list and whitelist\n  const proxyHeaderWhiteList = defaultProxyHeaderWhiteList\n    .concat(options.proxyHeaderWhiteList || [])\n    .map(header => header.toLowerCase())\n\n  const proxyHeaderExclusiveList = defaultProxyHeaderExclusiveList\n    .concat(options.proxyHeaderExclusiveList || [])\n    .map(header => header.toLowerCase())\n\n  // Get the headers we should send to the proxy\n  const proxyHeaders = getAllowedProxyHeaders(options.headers, proxyHeaderWhiteList)\n  proxyHeaders.host = constructProxyHost(options)\n\n  // Reduce headers to the ones not exclusive for the proxy\n  options.headers = Object.keys(options.headers || {}).reduce((headers, header) => {\n    const isAllowed = proxyHeaderExclusiveList.indexOf(header.toLowerCase()) === -1\n    if (isAllowed) {\n      headers[header] = options.headers[header]\n    }\n\n    return headers\n  }, {})\n\n  const tunnelFn = getTunnelFn(options, proxy)\n  const tunnelOptions = constructTunnelOptions(options, proxy, proxyHeaders)\n  options.agent = tunnelFn(tunnelOptions)\n\n  return options\n}\n\nfunction getTunnelFn(options, proxy) {\n  const uri = getUriParts(options)\n  const tunnelFnName = constructTunnelFnName(uri, proxy)\n  return tunnel[tunnelFnName]\n}\n\nfunction getUriParts(options) {\n  return uriParts.reduce((uri, part) => {\n    uri[part] = options[part]\n    return uri\n  }, {})\n}\n\nfunction constructTunnelFnName(uri, proxy) {\n  const uriProtocol = uri.protocol === 'https:' ? 'https' : 'http'\n  const proxyProtocol = proxy.protocol === 'https:' ? 'Https' : 'Http'\n  return [uriProtocol, proxyProtocol].join('Over')\n}\n\nfunction constructProxyHost(uri) {\n  const port = uri.port\n  const protocol = uri.protocol\n  let proxyHost = `${uri.hostname}:`\n\n  if (port) {\n    proxyHost += port\n  } else if (protocol === 'https:') {\n    proxyHost += '443'\n  } else {\n    proxyHost += '80'\n  }\n\n  return proxyHost\n}\n\nfunction getAllowedProxyHeaders(headers, whiteList) {\n  return Object.keys(headers)\n    .filter(header => whiteList.indexOf(header.toLowerCase()) !== -1)\n    .reduce((set, header) => {\n      set[header] = headers[header]\n      return set\n    }, {})\n}\n\nfunction constructTunnelOptions(options, proxy, proxyHeaders) {\n  return {\n    proxy: {\n      host: proxy.hostname,\n      port: +proxy.port,\n      proxyAuth: proxy.auth,\n      headers: proxyHeaders\n    },\n    headers: options.headers,\n    ca: options.ca,\n    cert: options.cert,\n    key: options.key,\n    passphrase: options.passphrase,\n    pfx: options.pfx,\n    ciphers: options.ciphers,\n    rejectUnauthorized: options.rejectUnauthorized,\n    secureOptions: options.secureOptions,\n    secureProtocol: options.secureProtocol\n  }\n}\n"],"mappings":"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"}