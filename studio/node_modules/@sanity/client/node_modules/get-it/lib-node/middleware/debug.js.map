{"version":3,"file":"debug.js","names":["SENSITIVE_HEADERS","hasOwn","Object","prototype","hasOwnProperty","redactKeys","source","redacted","target","key","call","indexOf","toLowerCase","opts","verbose","namespace","defaultLogger","debugIt","log","shortCircuit","enabled","requestId","processOptions","options","debug","onRequest","event","method","url","body","headers","redactSensitiveHeaders","JSON","stringify","onResponse","res","context","reqId","statusCode","statusMessage","stringifyBody","onError","err","message","contentType","isJson","tryFormat","parsed","parse"],"sources":["../../src/middleware/debug.js"],"sourcesContent":["import debugIt from 'debug'\n\nconst SENSITIVE_HEADERS = ['cookie', 'authorization']\n\nconst hasOwn = Object.prototype.hasOwnProperty\nconst redactKeys = (source, redacted) => {\n  const target = {}\n  for (const key in source) {\n    if (hasOwn.call(source, key)) {\n      target[key] = redacted.indexOf(key.toLowerCase()) > -1 ? '<redacted>' : source[key]\n    }\n  }\n  return target\n}\n\nexport default (opts = {}) => {\n  const verbose = opts.verbose\n  const namespace = opts.namespace || 'get-it'\n  const defaultLogger = debugIt(namespace)\n  const log = opts.log || defaultLogger\n  const shortCircuit = log === defaultLogger && !debugIt.enabled(namespace)\n  let requestId = 0\n\n  return {\n    processOptions: options => {\n      options.debug = log\n      options.requestId = options.requestId || ++requestId\n      return options\n    },\n\n    onRequest: event => {\n      // Short-circuit if not enabled, to save some CPU cycles with formatting stuff\n      if (shortCircuit || !event) {\n        return event\n      }\n\n      const options = event.options\n\n      log('[%s] HTTP %s %s', options.requestId, options.method, options.url)\n\n      if (verbose && options.body && typeof options.body === 'string') {\n        log('[%s] Request body: %s', options.requestId, options.body)\n      }\n\n      if (verbose && options.headers) {\n        const headers =\n          opts.redactSensitiveHeaders === false\n            ? options.headers\n            : redactKeys(options.headers, SENSITIVE_HEADERS)\n\n        log('[%s] Request headers: %s', options.requestId, JSON.stringify(headers, null, 2))\n      }\n\n      return event\n    },\n\n    onResponse: (res, context) => {\n      // Short-circuit if not enabled, to save some CPU cycles with formatting stuff\n      if (shortCircuit || !res) {\n        return res\n      }\n\n      const reqId = context.options.requestId\n\n      log('[%s] Response code: %s %s', reqId, res.statusCode, res.statusMessage)\n\n      if (verbose && res.body) {\n        log('[%s] Response body: %s', reqId, stringifyBody(res))\n      }\n\n      return res\n    },\n\n    onError: (err, context) => {\n      const reqId = context.options.requestId\n      if (!err) {\n        log('[%s] Error encountered, but handled by an earlier middleware', reqId)\n        return err\n      }\n\n      log('[%s] ERROR: %s', reqId, err.message)\n      return err\n    }\n  }\n}\n\nfunction stringifyBody(res) {\n  const contentType = (res.headers['content-type'] || '').toLowerCase()\n  const isJson = contentType.indexOf('application/json') !== -1\n  return isJson ? tryFormat(res.body) : res.body\n}\n\n// Attempt pretty-formatting JSON\nfunction tryFormat(body) {\n  try {\n    const parsed = typeof body === 'string' ? JSON.parse(body) : body\n    return JSON.stringify(parsed, null, 2)\n  } catch (err) {\n    return body\n  }\n}\n"],"mappings":"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"}