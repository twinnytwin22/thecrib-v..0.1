{"version":3,"file":"node-progress.js","names":["progressStream","require","normalizer","stage","prog","percent","percentage","total","length","loaded","transferred","lengthComputable","onHeaders","response","evt","progress","time","normalize","contentLength","headers","Number","isNaN","setLength","on","context","channels","publish","pipe","onRequest"],"sources":["../../../src/middleware/progress/node-progress.js"],"sourcesContent":["const progressStream = require('progress-stream')\n\nfunction normalizer(stage) {\n  return prog => ({\n    stage,\n    percent: prog.percentage,\n    total: prog.length,\n    loaded: prog.transferred,\n    lengthComputable: !(prog.length === 0 && prog.percentage === 0)\n  })\n}\n\nexport default () => ({\n  onHeaders: (response, evt) => {\n    const progress = progressStream({time: 16})\n    const normalize = normalizer('download')\n\n    // This is supposed to be handled automatically, but it has a bug,\n    // see https://github.com/freeall/progress-stream/pull/22\n    const contentLength = response.headers['content-length']\n    const length = contentLength && Number(contentLength)\n    if (!isNaN(length) && length > 0) {\n      progress.setLength(length)\n    }\n\n    progress.on('progress', prog => evt.context.channels.progress.publish(normalize(prog)))\n    return response.pipe(progress)\n  },\n\n  onRequest: evt => {\n    if (!evt.progress) {\n      return\n    }\n\n    const normalize = normalizer('upload')\n    evt.progress.on('progress', prog => evt.context.channels.progress.publish(normalize(prog)))\n  }\n})\n"],"mappings":";;;;;;;AAAA,MAAMA,cAAc,GAAGC,OAAO,CAAC,iBAAD,CAA9B;;AAEA,SAASC,UAAT,CAAoBC,KAApB,EAA2B;EACzB,OAAOC,IAAI,KAAK;IACdD,KADc;IAEdE,OAAO,EAAED,IAAI,CAACE,UAFA;IAGdC,KAAK,EAAEH,IAAI,CAACI,MAHE;IAIdC,MAAM,EAAEL,IAAI,CAACM,WAJC;IAKdC,gBAAgB,EAAE,EAAEP,IAAI,CAACI,MAAL,KAAgB,CAAhB,IAAqBJ,IAAI,CAACE,UAAL,KAAoB,CAA3C;EALJ,CAAL,CAAX;AAOD;;eAEc,OAAO;EACpBM,SAAS,EAAE,CAACC,QAAD,EAAWC,GAAX,KAAmB;IAC5B,MAAMC,QAAQ,GAAGf,cAAc,CAAC;MAACgB,IAAI,EAAE;IAAP,CAAD,CAA/B;IACA,MAAMC,SAAS,GAAGf,UAAU,CAAC,UAAD,CAA5B,CAF4B,CAI5B;IACA;;IACA,MAAMgB,aAAa,GAAGL,QAAQ,CAACM,OAAT,CAAiB,gBAAjB,CAAtB;IACA,MAAMX,MAAM,GAAGU,aAAa,IAAIE,MAAM,CAACF,aAAD,CAAtC;;IACA,IAAI,CAACG,KAAK,CAACb,MAAD,CAAN,IAAkBA,MAAM,GAAG,CAA/B,EAAkC;MAChCO,QAAQ,CAACO,SAAT,CAAmBd,MAAnB;IACD;;IAEDO,QAAQ,CAACQ,EAAT,CAAY,UAAZ,EAAwBnB,IAAI,IAAIU,GAAG,CAACU,OAAJ,CAAYC,QAAZ,CAAqBV,QAArB,CAA8BW,OAA9B,CAAsCT,SAAS,CAACb,IAAD,CAA/C,CAAhC;IACA,OAAOS,QAAQ,CAACc,IAAT,CAAcZ,QAAd,CAAP;EACD,CAfmB;EAiBpBa,SAAS,EAAEd,GAAG,IAAI;IAChB,IAAI,CAACA,GAAG,CAACC,QAAT,EAAmB;MACjB;IACD;;IAED,MAAME,SAAS,GAAGf,UAAU,CAAC,QAAD,CAA5B;IACAY,GAAG,CAACC,QAAJ,CAAaQ,EAAb,CAAgB,UAAhB,EAA4BnB,IAAI,IAAIU,GAAG,CAACU,OAAJ,CAAYC,QAAZ,CAAqBV,QAArB,CAA8BW,OAA9B,CAAsCT,SAAS,CAACb,IAAD,CAA/C,CAApC;EACD;AAxBmB,CAAP,C"}