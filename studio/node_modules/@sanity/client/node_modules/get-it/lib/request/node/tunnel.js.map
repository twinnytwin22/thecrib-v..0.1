{"version":3,"file":"tunnel.js","names":["url","require","tunnel","uriParts","defaultProxyHeaderWhiteList","defaultProxyHeaderExclusiveList","exports","shouldEnable","options","tunnelOption","Boolean","uri","parse","protocol","applyAgent","opts","proxy","proxyHeaderWhiteList","concat","map","header","toLowerCase","proxyHeaderExclusiveList","proxyHeaders","getAllowedProxyHeaders","headers","host","constructProxyHost","Object","keys","reduce","isAllowed","indexOf","tunnelFn","getTunnelFn","tunnelOptions","constructTunnelOptions","agent","getUriParts","tunnelFnName","constructTunnelFnName","part","uriProtocol","proxyProtocol","join","port","proxyHost","hostname","whiteList","filter","set","proxyAuth","auth","ca","cert","key","passphrase","pfx","ciphers","rejectUnauthorized","secureOptions","secureProtocol"],"sources":["../../../src/request/node/tunnel.js"],"sourcesContent":["/**\n * Code borrowed from https://github.com/request/request\n * Modified to be less request-specific, more functional\n * Apache License 2.0\n */\nconst url = require('url')\nconst tunnel = require('tunnel-agent')\n\nconst uriParts = [\n  'protocol',\n  'slashes',\n  'auth',\n  'host',\n  'port',\n  'hostname',\n  'hash',\n  'search',\n  'query',\n  'pathname',\n  'path',\n  'href'\n]\n\nconst defaultProxyHeaderWhiteList = [\n  'accept',\n  'accept-charset',\n  'accept-encoding',\n  'accept-language',\n  'accept-ranges',\n  'cache-control',\n  'content-encoding',\n  'content-language',\n  'content-location',\n  'content-md5',\n  'content-range',\n  'content-type',\n  'connection',\n  'date',\n  'expect',\n  'max-forwards',\n  'pragma',\n  'referer',\n  'te',\n  'user-agent',\n  'via'\n]\n\nconst defaultProxyHeaderExclusiveList = ['proxy-authorization']\n\nexports.shouldEnable = (options, tunnelOption) => {\n  // Tunnel HTTPS by default. Allow the user to override this setting.\n\n  // If user has specified a specific tunnel override...\n  if (typeof options.tunnel !== 'undefined') {\n    return Boolean(options.tunnel)\n  }\n\n  // If the destination is HTTPS, tunnel.\n  const uri = url.parse(options.url)\n  if (uri.protocol === 'https:') {\n    return true\n  }\n\n  // Otherwise, do not use tunnel.\n  return false\n}\n\nexports.applyAgent = (opts = {}, proxy) => {\n  const options = Object.assign({}, opts)\n\n  // Setup proxy header exclusive list and whitelist\n  const proxyHeaderWhiteList = defaultProxyHeaderWhiteList\n    .concat(options.proxyHeaderWhiteList || [])\n    .map(header => header.toLowerCase())\n\n  const proxyHeaderExclusiveList = defaultProxyHeaderExclusiveList\n    .concat(options.proxyHeaderExclusiveList || [])\n    .map(header => header.toLowerCase())\n\n  // Get the headers we should send to the proxy\n  const proxyHeaders = getAllowedProxyHeaders(options.headers, proxyHeaderWhiteList)\n  proxyHeaders.host = constructProxyHost(options)\n\n  // Reduce headers to the ones not exclusive for the proxy\n  options.headers = Object.keys(options.headers || {}).reduce((headers, header) => {\n    const isAllowed = proxyHeaderExclusiveList.indexOf(header.toLowerCase()) === -1\n    if (isAllowed) {\n      headers[header] = options.headers[header]\n    }\n\n    return headers\n  }, {})\n\n  const tunnelFn = getTunnelFn(options, proxy)\n  const tunnelOptions = constructTunnelOptions(options, proxy, proxyHeaders)\n  options.agent = tunnelFn(tunnelOptions)\n\n  return options\n}\n\nfunction getTunnelFn(options, proxy) {\n  const uri = getUriParts(options)\n  const tunnelFnName = constructTunnelFnName(uri, proxy)\n  return tunnel[tunnelFnName]\n}\n\nfunction getUriParts(options) {\n  return uriParts.reduce((uri, part) => {\n    uri[part] = options[part]\n    return uri\n  }, {})\n}\n\nfunction constructTunnelFnName(uri, proxy) {\n  const uriProtocol = uri.protocol === 'https:' ? 'https' : 'http'\n  const proxyProtocol = proxy.protocol === 'https:' ? 'Https' : 'Http'\n  return [uriProtocol, proxyProtocol].join('Over')\n}\n\nfunction constructProxyHost(uri) {\n  const port = uri.port\n  const protocol = uri.protocol\n  let proxyHost = `${uri.hostname}:`\n\n  if (port) {\n    proxyHost += port\n  } else if (protocol === 'https:') {\n    proxyHost += '443'\n  } else {\n    proxyHost += '80'\n  }\n\n  return proxyHost\n}\n\nfunction getAllowedProxyHeaders(headers, whiteList) {\n  return Object.keys(headers)\n    .filter(header => whiteList.indexOf(header.toLowerCase()) !== -1)\n    .reduce((set, header) => {\n      set[header] = headers[header]\n      return set\n    }, {})\n}\n\nfunction constructTunnelOptions(options, proxy, proxyHeaders) {\n  return {\n    proxy: {\n      host: proxy.hostname,\n      port: +proxy.port,\n      proxyAuth: proxy.auth,\n      headers: proxyHeaders\n    },\n    headers: options.headers,\n    ca: options.ca,\n    cert: options.cert,\n    key: options.key,\n    passphrase: options.passphrase,\n    pfx: options.pfx,\n    ciphers: options.ciphers,\n    rejectUnauthorized: options.rejectUnauthorized,\n    secureOptions: options.secureOptions,\n    secureProtocol: options.secureProtocol\n  }\n}\n"],"mappings":"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"}